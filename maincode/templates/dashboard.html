<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gap Analysis Dashboard</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #1e3a8a;
            --secondary-color: #3b82f6;
            --accent-color: #dc2626;
            --success-color: #059669;
            --warning-color: #d97706;
            --dark-color: #1f2937;
            --light-bg: #f8fafc;
            --shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            --shadow-hover: 0 20px 40px rgba(0, 0, 0, 0.15);
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            min-height: 100vh;
        }

        .navbar {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--dark-color) 100%);
            box-shadow: var(--shadow);
            padding: 1rem 0;
        }

        .navbar-brand {
            font-size: 1.5rem;
            font-weight: 700;
            color: white !important;
        }

        .navbar-nav .nav-link {
            color: rgba(255, 255, 255, 0.8) !important;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .navbar-nav .nav-link:hover {
            color: white !important;
            transform: translateY(-2px);
        }

        .user-info {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 25px;
            padding: 0.5rem 1rem;
            margin-right: 1rem;
            backdrop-filter: blur(10px);
        }

        .logout-btn {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            border: none;
            border-radius: 25px;
            padding: 0.5rem 1rem;
            color: white;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(239, 68, 68, 0.3);
        }

        .filter-card, .data-table {
            background: white;
            border-radius: 20px;
            box-shadow: var(--shadow);
            border: 1px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }

        .filter-card:hover, .data-table:hover {
            box-shadow: var(--shadow-hover);
            transform: translateY(-2px);
        }

        .filter-header {
            background: linear-gradient(135deg, var(--secondary-color) 0%, var(--primary-color) 100%);
            color: white;
            border-radius: 20px 20px 0 0;
            padding: 1.5rem;
        }

        .filter-header h5 {
            margin: 0;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .form-control, .form-select {
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 0.75rem;
            transition: all 0.3s ease;
            font-size: 0.95rem;
        }

        .form-control:focus, .form-select:focus {
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            transform: translateY(-2px);
        }

        .btn {
            border-radius: 12px;
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            transition: all 0.3s ease;
            border: none;
            position: relative;
            overflow: hidden;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--secondary-color) 0%, var(--primary-color) 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(59, 130, 246, 0.3);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
            color: white;
        }

        .btn-info {
            background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success-color) 0%, #047857 100%);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--warning-color) 0%, #ea580c 100%);
            color: white;
        }

        .table-container {
            background: white;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: var(--shadow);
        }

        .table-header {
            background: linear-gradient(135deg, var(--dark-color) 0%, var(--primary-color) 100%);
            color: white;
            padding: 1.5rem;
        }

        .table-header h4 {
            margin: 0;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .table-header-controls {
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .record-badge {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 25px;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .download-btn, .save-all-btn {
            background: linear-gradient(135deg, var(--success-color) 0%, #047857 100%);
            border: none;
            border-radius: 20px;
            padding: 0.5rem 1rem;
            color: white;
            font-weight: 600;
            transition: all 0.3s ease;
            text-decoration: none;
        }

        .download-btn:hover, .save-all-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(5, 150, 105, 0.3);
            color: white;
        }

        .save-all-btn {
            background: linear-gradient(135deg, var(--warning-color) 0%, #ea580c 100%);
            display: none;
        }

        .save-all-btn:hover {
            box-shadow: 0 8px 25px rgba(217, 119, 6, 0.3);
        }

        .table {
            margin: 0;
        }

        .table th {
            background: var(--light-bg);
            color: var(--dark-color);
            border: none;
            font-weight: 700;
            padding: 1rem 0.75rem;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .table td {
            padding: 1rem 0.75rem;
            border-bottom: 1px solid #f1f5f9;
            vertical-align: middle;
            font-size: 0.9rem;
        }

        .table tbody tr {
            transition: all 0.2s ease;
        }

        .table tbody tr:hover {
            background: var(--light-bg);
            transform: scale(1.01);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }

        .table tbody tr.selected {
            background: rgba(59, 130, 246, 0.1);
            border-left: 4px solid var(--secondary-color);
        }

        .fill-rate-badge {
            font-size: 0.85rem;
            font-weight: 700;
            padding: 0.4rem 0.8rem;
            border-radius: 20px;
            text-align: center;
            min-width: 60px;
            display: inline-block;
        }

        .fill-rate-low {
            background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
            color: var(--accent-color);
            border: 2px solid #fecaca;
        }

        .feedback-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .feedback-completed {
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
            color: var(--success-color);
            padding: 0.4rem 0.8rem;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
            border: 2px solid #86efac;
            white-space: nowrap;
        }

        .feedback-pending {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .feedback-pending select {
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 0.4rem;
            font-size: 0.8rem;
            min-width: 160px;
            flex: 1;
        }

        .feedback-pending button {
            background: linear-gradient(135deg, var(--success-color) 0%, #047857 100%);
            border: none;
            border-radius: 8px;
            padding: 0.4rem 0.8rem;
            color: white;
            font-size: 0.8rem;
            font-weight: 600;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .feedback-pending button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(5, 150, 105, 0.3);
        }

        .feedback-pending button:disabled {
            background: #9ca3af;
            transform: none;
            box-shadow: none;
        }

        .record-checkbox {
            transform: scale(1.2);
            margin-right: 0.5rem;
        }

        .loading {
            text-align: center;
            padding: 4rem;
            background: var(--light-bg);
            border-radius: 15px;
            margin: 2rem;
        }

        .spinner-border {
            color: var(--secondary-color);
            width: 3rem;
            height: 3rem;
        }

        .alert {
            border-radius: 15px;
            border: none;
            padding: 1.2rem;
            font-weight: 600;
        }

        .text-truncate-custom {
            max-width: 200px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .date-input-group {
            position: relative;
        }

        .date-input-group .form-control {
            padding-left: 2.5rem;
        }

        .date-input-group i {
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--secondary-color);
            z-index: 5;
        }

        .cascading-hint {
            font-size: 0.8rem;
            color: #6b7280;
            font-style: italic;
            margin-top: 4px;
        }

        .session-warning {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border-left: 4px solid var(--warning-color);
            color: #92400e;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            display: none;
        }

        /* Improved responsive design */
        @media (max-width: 768px) {
            .table-responsive {
                font-size: 0.8rem;
            }
            
            .btn {
                padding: 0.6rem 1rem;
                font-size: 0.85rem;
            }
            
            .filter-card .row > div {
                margin-bottom: 1rem;
            }

            .feedback-pending {
                flex-direction: column;
                gap: 0.5rem;
                align-items: stretch;
            }

            .feedback-pending select {
                min-width: 100%;
            }

            .feedback-pending button {
                width: 100%;
                justify-content: center;
            }

            .navbar-nav {
                text-align: center;
            }

            .user-info {
                margin: 0.5rem 0;
            }

            .table-header-controls {
                flex-direction: column;
                gap: 0.5rem;
                align-items: stretch;
            }

            .text-truncate-custom {
                max-width: 150px;
            }

            /* Make table more mobile friendly */
            .table td {
                padding: 0.5rem 0.25rem;
                font-size: 0.8rem;
            }

            .table th {
                padding: 0.75rem 0.25rem;
                font-size: 0.75rem;
            }
        }

        /* Extra mobile optimization */
        @media (max-width: 480px) {
            .feedback-pending select {
                font-size: 0.75rem;
                padding: 0.3rem;
            }

            .feedback-pending button {
                padding: 0.3rem 0.6rem;
                font-size: 0.75rem;
            }

            .text-truncate-custom {
                max-width: 120px;
            }
        }

        .animate-fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Bulk selection styling */
        .bulk-selection-bar {
            background: linear-gradient(135deg, var(--secondary-color) 0%, var(--primary-color) 100%);
            color: white;
            padding: 1rem;
            border-radius: 15px;
            margin-bottom: 1rem;
            display: none;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .bulk-selection-bar.show {
            display: flex;
        }

        .bulk-selection-info {
            display: flex;
            align-items: center;
            gap: 1rem;
            flex: 1;
        }

        .bulk-actions {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .bulk-reason-select {
            background: white;
            border: none;
            border-radius: 8px;
            padding: 0.5rem;
            font-weight: 600;
            min-width: 200px;
        }

        @media (max-width: 768px) {
            .bulk-selection-bar {
                flex-direction: column;
                align-items: stretch;
            }

            .bulk-selection-info {
                justify-content: center;
            }

            .bulk-actions {
                justify-content: center;
            }

            .bulk-reason-select {
                min-width: 100%;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="fas fa-analytics"></i>
                Gap Analysis Dashboard
            </a>
            
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            
            <div class="collapse navbar-collapse" id="navbarNav">
                <div class="navbar-nav ms-auto d-flex align-items-center">
                    <div class="user-info">
                        <i class="fas fa-user me-2"></i>
                        <span id="user-email">Loading...</span>
                    </div>
                    <button class="logout-btn" id="logout-btn">
                        <i class="fas fa-sign-out-alt me-1"></i>
                        Logout
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Session Warning -->
        <div class="session-warning" id="session-warning">
            <i class="fas fa-clock me-2"></i>
            <strong>Session Expiring Soon:</strong> <span id="session-timer"></span>
        </div>

        <!-- Enhanced Filters Section -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="filter-card animate-fade-in">
                    <div class="filter-header">
                        <h5><i class="fas fa-sliders-h"></i>Smart Filters</h5>
                    </div>
                    <div class="p-4">
                        <div class="row g-3">
                            <!-- State Filter -->
                            <div class="col-lg-2 col-md-4">
                                <label for="state-filter" class="form-label">
                                    <i class="fas fa-map-marker-alt me-1"></i>State
                                </label>
                                <select class="form-select" id="state-filter">
                                    <option value="">All States</option>
                                </select>
                                <div class="cascading-hint">Filter plants by state</div>
                            </div>
                            
                            <!-- Plant Filter -->
                            <div class="col-lg-2 col-md-4">
                                <label for="plant-filter" class="form-label">
                                    <i class="fas fa-industry me-1"></i>Plant
                                </label>
                                <select class="form-select" id="plant-filter">
                                    <option value="">All Plants</option>
                                </select>
                                <div class="cascading-hint">Shows record counts</div>
                            </div>

                            <!-- Material Filter -->
                            <div class="col-lg-2 col-md-4">
                                <label for="material-filter" class="form-label">
                                    <i class="fas fa-box me-1"></i>Material
                                </label>
                                <select class="form-select" id="material-filter">
                                    <option value="">All Materials</option>
                                </select>
                                <div class="cascading-hint">Filter by product</div>
                            </div>
                            
                            <!-- Date From -->
                            <div class="col-lg-2 col-md-4">
                                <label for="date-from-filter" class="form-label">
                                    <i class="fas fa-calendar-alt me-1"></i>Date From
                                </label>
                                <div class="date-input-group">
                                    <i class="fas fa-calendar"></i>
                                    <input type="date" class="form-control" id="date-from-filter">
                                </div>
                            </div>
                            
                            <!-- Date To -->
                            <div class="col-lg-2 col-md-4">
                                <label for="date-to-filter" class="form-label">
                                    <i class="fas fa-calendar-check me-1"></i>Date To
                                </label>
                                <div class="date-input-group">
                                    <i class="fas fa-calendar"></i>
                                    <input type="date" class="form-control" id="date-to-filter">
                                </div>
                            </div>
                            
                            <!-- Action Buttons -->
                            <div class="col-lg-2 col-md-4 d-flex align-items-end gap-2">
                                <button class="btn btn-primary flex-fill" id="apply-filters">
                                    <i class="fas fa-search me-1"></i>Apply
                                </button>
                                <button class="btn btn-secondary" id="clear-filters">
                                    <i class="fas fa-eraser me-1"></i>Clear
                                </button>
                                <button class="btn btn-info" id="today-filter">
                                    <i class="fas fa-calendar-day me-1"></i>Today
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bulk Selection Bar -->
        <div class="bulk-selection-bar" id="bulk-selection-bar">
            <div class="bulk-selection-info">
                <i class="fas fa-check-circle me-2"></i>
                <span id="selected-count">0</span> records selected
            </div>
            <div class="bulk-actions">
                <select class="bulk-reason-select" id="bulk-reason-select">
                    <option value="">Select reason for all...</option>
                </select>
                <button class="btn btn-warning" id="save-all-btn" disabled>
                    <i class="fas fa-save me-1"></i>Save All
                </button>
                <button class="btn btn-secondary" id="clear-selection-btn">
                    <i class="fas fa-times me-1"></i>Clear Selection
                </button>
            </div>
        </div>

        <!-- Enhanced Data Table -->
        <div class="table-container animate-fade-in">
            <div class="table-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h4><i class="fas fa-table"></i>Gap Analysis Records (Fill Rate < 95%)-ZEPTO</h4>
                    <div class="table-header-controls">
                        <div class="record-badge" id="record-count">0 records</div>
                        <a href="#" class="download-btn" id="download-btn">
                            <i class="fas fa-download me-1"></i>Download Excel
                        </a>
                    </div>
                </div>
            </div>
            
            <div id="loading" class="loading">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <h5 class="mt-3 text-muted">Loading gap analysis data...</h5>
            </div>
            
            <div id="data-container" style="display: none;">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th>
                                    <input type="checkbox" class="form-check-input" id="select-all-checkbox">
                                    Select
                                </th>
                                <th>S.No</th>
                                <th>PO Number</th>
                                <th>Material Description</th>
                                <th>PO Date</th>
                                <th>Delivery Date</th>
                                <th>PO Qty (L)</th>
                                <th>Sales Qty</th>
                                <th>Fill Rate</th>
                                <th>Feedback Status</th>
                            </tr>
                        </thead>
                        <tbody id="data-table-body">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Success Modal -->
    <div class="modal fade" id="successModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-check-circle me-2"></i>
                        Feedback Saved
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    <i class="fas fa-check-circle text-success mb-3" style="font-size: 3rem;"></i>
                    <h5 id="success-message">Feedback Submitted Successfully!</h5>
                    <p class="text-muted" id="success-details">Thank you for providing feedback on this gap analysis record.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-success" data-bs-dismiss="modal">
                        <i class="fas fa-thumbs-up me-1"></i>Great!
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script>
        let allData = [];
        let plantsByState = {};
        let materials = [];
        let sessionTimer = null;
        let currentFilters = {};
        let selectedRecords = new Set();

        // Reasons for non-fulfillment
        const REASONS = [
            "Product non Availability at Factory",
            "Product non Availability at SO",
            "Product non availability at CFA",
            "Supply not made as per PO time lines",
            "PO price issue",
            "Appointment issues",
            "Supply rejected by customer",
            "Mutiple point Delivery",
            "Due to Quality Issue",
            "Due to Delayed Delivery"
        ];

        // Load dashboard data on page load
        document.addEventListener('DOMContentLoaded', function() {
            verifySession();
            loadFilterOptions();
            loadLowFillRateData();
            startSessionTimer();
            initializeBulkActions();
            
            // Event handlers
            document.getElementById('logout-btn').addEventListener('click', logout);
            document.getElementById('download-btn').addEventListener('click', downloadData);
        });

        // Initialize bulk action functionality
        function initializeBulkActions() {
            // Populate bulk reason dropdown
            const bulkReasonSelect = document.getElementById('bulk-reason-select');
            REASONS.forEach(reason => {
                const option = document.createElement('option');
                option.value = reason;
                option.textContent = reason;
                bulkReasonSelect.appendChild(option);
            });

            // Bulk reason selection handler
            bulkReasonSelect.addEventListener('change', function() {
                const saveAllBtn = document.getElementById('save-all-btn');
                // Only enable save all if reason is selected AND more than 1 record is selected
                saveAllBtn.disabled = !this.value || selectedRecords.size <= 1;
            });

            // Save all button handler
            document.getElementById('save-all-btn').addEventListener('click', saveAllSelected);

            // Clear selection handler
            document.getElementById('clear-selection-btn').addEventListener('click', clearSelection);

            // Select all checkbox handler
            document.getElementById('select-all-checkbox').addEventListener('change', toggleSelectAll);
        }

        // Toggle select all functionality
        function toggleSelectAll() {
            const selectAllCheckbox = document.getElementById('select-all-checkbox');
            const recordCheckboxes = document.querySelectorAll('.record-checkbox:not(:disabled)');
            
            recordCheckboxes.forEach(checkbox => {
                checkbox.checked = selectAllCheckbox.checked;
                handleRecordSelection(checkbox);
            });
        }

        // Handle individual record selection
        function handleRecordSelection(checkbox) {
            const recordId = parseInt(checkbox.dataset.recordId);
            const row = checkbox.closest('tr');
            
            if (checkbox.checked) {
                selectedRecords.add(recordId);
                row.classList.add('selected');
            } else {
                selectedRecords.delete(recordId);
                row.classList.remove('selected');
            }
            
            updateBulkSelectionUI();
        }

        // Update bulk selection UI
        function updateBulkSelectionUI() {
            const bulkBar = document.getElementById('bulk-selection-bar');
            const selectedCountSpan = document.getElementById('selected-count');
            const selectAllCheckbox = document.getElementById('select-all-checkbox');
            
            selectedCountSpan.textContent = selectedRecords.size;
            
            if (selectedRecords.size > 0) {
                bulkBar.classList.add('show');
            } else {
                bulkBar.classList.remove('show');
                document.getElementById('bulk-reason-select').value = '';
                document.getElementById('save-all-btn').disabled = true;
            }
            
            // Update select all checkbox state
            const totalCheckboxes = document.querySelectorAll('.record-checkbox:not(:disabled)').length;
            const checkedCheckboxes = document.querySelectorAll('.record-checkbox:checked').length;
            
            selectAllCheckbox.indeterminate = checkedCheckboxes > 0 && checkedCheckboxes < totalCheckboxes;
            selectAllCheckbox.checked = checkedCheckboxes > 0 && checkedCheckboxes === totalCheckboxes;
        }

        // Clear all selections
        function clearSelection() {
            selectedRecords.clear();
            document.querySelectorAll('.record-checkbox').forEach(checkbox => {
                checkbox.checked = false;
            });
            document.querySelectorAll('tr.selected').forEach(row => {
                row.classList.remove('selected');
            });
            updateBulkSelectionUI();
        }

        // Save all selected records
        async function saveAllSelected() {
            const bulkReason = document.getElementById('bulk-reason-select').value;
            if (!bulkReason || selectedRecords.size === 0) return;

            const saveAllBtn = document.getElementById('save-all-btn');
            const originalText = saveAllBtn.innerHTML;
            
            saveAllBtn.disabled = true;
            saveAllBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';

            let successCount = 0;
            let errorCount = 0;
            const totalRecords = selectedRecords.size;

            for (const recordId of selectedRecords) {
                try {
                    const response = await fetch('/api/submit-feedback', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            record_id: recordId,
                            reason: bulkReason,
                            comments: ''
                        })
                    });

                    const result = await response.json();

                    if (response.ok) {
                        successCount++;
                        // Update the UI for this record
                        updateRecordFeedbackUI(recordId, bulkReason);
                    } else {
                        errorCount++;
                        console.error(`Error saving feedback for record ${recordId}:`, result.error);
                    }
                } catch (error) {
                    errorCount++;
                    console.error(`Error saving feedback for record ${recordId}:`, error);
                }
            }

            // Clear selections after saving
            clearSelection();

            // Show success modal with results
            showBulkSaveResults(successCount, errorCount, totalRecords);

            // Reset button
            saveAllBtn.innerHTML = originalText;
            saveAllBtn.disabled = true;
        }

        // Update individual record feedback UI
        function updateRecordFeedbackUI(recordId, reason) {
            const checkbox = document.querySelector(`.record-checkbox[data-record-id="${recordId}"]`);
            if (checkbox) {
                const row = checkbox.closest('tr');
                const feedbackCell = row.querySelector('td:last-child');
                feedbackCell.innerHTML = `
                    <div class="feedback-status">
                        <span class="feedback-completed">
                            <i class="fas fa-check-circle me-1"></i>
                            ${reason}
                        </span>
                    </div>
                `;
                
                // Disable checkbox since feedback is complete
                checkbox.disabled = true;
                checkbox.checked = false;
                row.classList.remove('selected');
            }
        }

        // Show bulk save results
        function showBulkSaveResults(successCount, errorCount, totalRecords) {
            const modal = document.getElementById('successModal');
            const messageEl = document.getElementById('success-message');
            const detailsEl = document.getElementById('success-details');

            if (errorCount === 0) {
                messageEl.textContent = `All ${successCount} Records Saved Successfully!`;
                detailsEl.textContent = 'Thank you for providing feedback on multiple gap analysis records.';
            } else if (successCount > 0) {
                messageEl.textContent = `${successCount} of ${totalRecords} Records Saved`;
                detailsEl.textContent = `${errorCount} records could not be saved due to errors. Please check individual records and try again.`;
            } else {
                messageEl.textContent = 'No Records Could Be Saved';
                detailsEl.textContent = 'All selected records encountered errors. Please try again or contact support.';
            }

            new bootstrap.Modal(modal).show();
        }

        // Verify session and load user info
        async function verifySession() {
            try {
                const response = await fetch('/api/verify-session');
                const result = await response.json();
                
                if (!response.ok || !result.valid) {
                    window.location.href = '/login';
                    return;
                }
                
                document.getElementById('user-email').textContent = result.user_email;
                
                if (result.time_remaining_minutes < 30) {
                    showSessionWarning(result.time_remaining_minutes);
                }
                
            } catch (error) {
                console.error('Session verification error:', error);
                window.location.href = '/login';
            }
        }

        function startSessionTimer() {
            sessionTimer = setInterval(verifySession, 5 * 60 * 1000);
        }

        function showSessionWarning(minutesRemaining) {
            const sessionWarning = document.getElementById('session-warning');
            const sessionTimerSpan = document.getElementById('session-timer');
            
            sessionTimerSpan.textContent = `${minutesRemaining} minutes remaining`;
            sessionWarning.style.display = 'block';
        }

        async function logout() {
            try {
                const response = await fetch('/api/logout', {
                    method: 'POST'
                });
                
                if (sessionTimer) {
                    clearInterval(sessionTimer);
                }
                
                window.location.href = '/login';
                
            } catch (error) {
                console.error('Logout error:', error);
                window.location.href = '/login';
            }
        }

        async function downloadData(event) {
            event.preventDefault();
            
            try {
                const downloadBtn = document.getElementById('download-btn');
                const originalText = downloadBtn.innerHTML;
                
                downloadBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Generating...';
                downloadBtn.style.pointerEvents = 'none';
                
                let url = '/api/download-data';
                const params = new URLSearchParams();
                
                if (currentFilters.state) params.append('state', currentFilters.state);
                if (currentFilters.plant) params.append('plant', currentFilters.plant);
                if (currentFilters.material) params.append('material', currentFilters.material);
                if (currentFilters.dateFrom) params.append('date_from', currentFilters.dateFrom);
                if (currentFilters.dateTo) params.append('date_to', currentFilters.dateTo);
                
                if (params.toString()) {
                    url += '?' + params.toString();
                }
                
                const link = document.createElement('a');
                link.href = url;
                link.download = '';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                setTimeout(() => {
                    downloadBtn.innerHTML = originalText;
                    downloadBtn.style.pointerEvents = 'auto';
                }, 2000);
                
            } catch (error) {
                console.error('Download error:', error);
                alert('Error downloading data. Please try again.');
                
                const downloadBtn = document.getElementById('download-btn');
                downloadBtn.innerHTML = '<i class="fas fa-download me-1"></i>Download Excel';
                downloadBtn.style.pointerEvents = 'auto';
            }
        }

        async function loadFilterOptions() {
            try {
                const response = await fetch('/api/filter-options');
                const data = await response.json();
                
                if (data.error) {
                    console.error('Error loading filter options:', data.error);
                    return;
                }
                
                plantsByState = data.plants_by_state;
                materials = data.materials;
                
                const stateSelect = document.getElementById('state-filter');
                stateSelect.innerHTML = '<option value="">All States</option>';
                data.states.forEach(state => {
                    const option = document.createElement('option');
                    option.value = state;
                    option.textContent = state;
                    stateSelect.appendChild(option);
                });

                const materialSelect = document.getElementById('material-filter');
                materialSelect.innerHTML = '<option value="">All Materials</option>';
                data.materials.forEach(material => {
                    const option = document.createElement('option');
                    option.value = material;
                    option.textContent = material;
                    materialSelect.appendChild(option);
                });
                
                populateAllPlants();
                
            } catch (error) {
                console.error('Error loading filter options:', error);
                if (error.message.includes('401')) {
                    window.location.href = '/login';
                }
            }
        }

        function populateAllPlants() {
            const plantSelect = document.getElementById('plant-filter');
            plantSelect.innerHTML = '<option value="">All Plants</option>';
            
            Object.keys(plantsByState).forEach(state => {
                plantsByState[state].forEach(plant => {
                    const option = document.createElement('option');
                    option.value = plant.name;
                    option.textContent = `${plant.name} (${plant.count} records)`;
                    plantSelect.appendChild(option);
                });
            });
        }

        document.getElementById('state-filter').addEventListener('change', function() {
            const selectedState = this.value;
            const plantSelect = document.getElementById('plant-filter');
            
            plantSelect.value = '';
            
            if (selectedState === '') {
                populateAllPlants();
            } else {
                plantSelect.innerHTML = '<option value="">All Plants</option>';
                
                if (plantsByState[selectedState]) {
                    plantsByState[selectedState].forEach(plant => {
                        const option = document.createElement('option');
                        option.value = plant.name;
                        option.textContent = `${plant.name} (${plant.count} records)`;
                        plantSelect.appendChild(option);
                    });
                }
            }
        });

        async function loadLowFillRateData() {
            try {
                const response = await fetch('/api/low-fill-rate-data');
                const result = await response.json();
                
                if (result.error) {
                    document.getElementById('loading').innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Error loading data: ${result.error}
                        </div>
                    `;
                    return;
                }
                
                allData = result.data;
                displayData(allData);
                
                document.getElementById('loading').style.display = 'none';
                document.getElementById('data-container').style.display = 'block';
                
            } catch (error) {
                console.error('Error loading data:', error);
                if (error.message.includes('401')) {
                    window.location.href = '/login';
                    return;
                }
                document.getElementById('loading').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Error loading data. Please try again.
                    </div>
                `;
            }
        }

        function displayData(data) {
            const tbody = document.getElementById('data-table-body');
            const recordCount = document.getElementById('record-count');
            
            tbody.innerHTML = '';
            recordCount.textContent = `${data.length} records`;
            
            // Clear selections when new data is loaded
            clearSelection();
            
            if (data.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="10" class="text-center py-5">
                            <i class="fas fa-info-circle text-muted me-2"></i>
                            No gap analysis records found with fill rate < 95%
                        </td>
                    </tr>
                `;
                return;
            }
            
            data.forEach((record, index) => {
                const row = document.createElement('tr');
                
                let checkboxContent = '';
                let feedbackContent = '';
                
                if (record.has_feedback) {
                    checkboxContent = `<input type="checkbox" class="form-check-input record-checkbox" disabled>`;
                    feedbackContent = `
                        <div class="feedback-status">
                            <span class="feedback-completed">
                                <i class="fas fa-check-circle me-1"></i>
                                ${record.feedback_reason}
                            </span>
                        </div>
                    `;
                } else {
                    checkboxContent = `<input type="checkbox" class="form-check-input record-checkbox" data-record-id="${record.id}">`;
                    feedbackContent = `
                        <div class="feedback-pending">
                            <select class="reason-select" data-record-id="${record.id}">
                                <option value="">Select reason...</option>
                                ${REASONS.map(reason => `<option value="${reason}">${reason}</option>`).join('')}
                            </select>
                            <button class="save-btn" data-record-id="${record.id}" disabled>
                                <i class="fas fa-save"></i> Save
                            </button>
                        </div>
                    `;
                }
                
                row.innerHTML = `
                    <td>${checkboxContent}</td>
                    <td><span class="fw-bold text-primary">${index + 1}</span></td>
                    <td><span class="fw-bold">${record.po_no}</span></td>
                    <td>
                        <div class="text-truncate-custom" title="${record.material_description}">
                            ${record.material_description}
                        </div>
                    </td>
                    <td><small class="text-muted">${record.po_date || 'N/A'}</small></td>
                    <td><small class="text-muted">${record.delivery_date || 'N/A'}</small></td>
                    <td><span class="fw-semibold">${record.po_quantity.toLocaleString()}</span></td>
                    <td><span class="fw-semibold">${record.sales_quantity.toLocaleString()}</span></td>
                    <td>
                        <span class="fill-rate-badge fill-rate-low">
                            ${record.fill_rate_percent.toFixed(1)}%
                        </span>
                    </td>
                    <td>${feedbackContent}</td>
                `;
                tbody.appendChild(row);
            });

            addInlineFeedbackListeners();
            addCheckboxListeners();
        }

        function addCheckboxListeners() {
            document.querySelectorAll('.record-checkbox:not(:disabled)').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    handleRecordSelection(this);
                });
            });
        }

        function addInlineFeedbackListeners() {
            document.querySelectorAll('.reason-select').forEach(select => {
                select.addEventListener('change', function() {
                    const saveBtn = document.querySelector(`.save-btn[data-record-id="${this.dataset.recordId}"]`);
                    saveBtn.disabled = !this.value;
                });
            });

            document.querySelectorAll('.save-btn').forEach(button => {
                button.addEventListener('click', async function() {
                    const recordId = this.dataset.recordId;
                    const reasonSelect = document.querySelector(`.reason-select[data-record-id="${recordId}"]`);
                    const reason = reasonSelect.value;

                    if (!reason) return;

                    try {
                        this.disabled = true;
                        this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';

                        const response = await fetch('/api/submit-feedback', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                record_id: parseInt(recordId),
                                reason: reason,
                                comments: ''
                            })
                        });

                        const result = await response.json();

                        if (!response.ok) {
                            if (response.status === 401) {
                                window.location.href = '/login';
                                return;
                            }
                            throw new Error(result.error);
                        }

                        updateRecordFeedbackUI(parseInt(recordId), reason);
                        
                        document.getElementById('success-message').textContent = 'Feedback Submitted Successfully!';
                        document.getElementById('success-details').textContent = 'Thank you for providing feedback on this gap analysis record.';
                        new bootstrap.Modal(document.getElementById('successModal')).show();

                    } catch (error) {
                        console.error('Error saving feedback:', error);
                        this.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Error';
                        this.style.background = '#ef4444';
                        this.disabled = false;
                        
                        setTimeout(() => {
                            this.innerHTML = '<i class="fas fa-save"></i> Save';
                            this.style.background = '';
                        }, 3000);
                    }
                });
            });
        }

        // Filter functionality
        document.getElementById('apply-filters').addEventListener('click', function() {
            const stateFilter = document.getElementById('state-filter').value;
            const plantFilter = document.getElementById('plant-filter').value;
            const materialFilter = document.getElementById('material-filter').value;
            const dateFromFilter = document.getElementById('date-from-filter').value;
            const dateToFilter = document.getElementById('date-to-filter').value;
            
            applyFilters(stateFilter, plantFilter, materialFilter, dateFromFilter, dateToFilter);
        });
        
        document.getElementById('clear-filters').addEventListener('click', function() {
            document.getElementById('state-filter').value = '';
            document.getElementById('plant-filter').value = '';
            document.getElementById('material-filter').value = '';
            document.getElementById('date-from-filter').value = '';
            document.getElementById('date-to-filter').value = '';
            
            currentFilters = {};
            populateAllPlants();
            loadLowFillRateData();
        });

        document.getElementById('today-filter').addEventListener('click', function() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('date-from-filter').value = today;
            document.getElementById('date-to-filter').value = today;
            
            const stateFilter = document.getElementById('state-filter').value;
            const plantFilter = document.getElementById('plant-filter').value;
            const materialFilter = document.getElementById('material-filter').value;
            
            applyFilters(stateFilter, plantFilter, materialFilter, today, today);
        });

        async function applyFilters(state, plant, material, dateFrom, dateTo) {
            try {
                currentFilters = {
                    state: state,
                    plant: plant,
                    material: material,
                    dateFrom: dateFrom,
                    dateTo: dateTo
                };
                
                document.getElementById('loading').style.display = 'block';
                document.getElementById('data-container').style.display = 'none';
                
                let url = '/api/filtered-data?';
                const params = new URLSearchParams();
                
                if (state) params.append('state', state);
                if (plant) params.append('plant', plant);
                if (material) params.append('material', material);
                if (dateFrom) params.append('date_from', dateFrom);
                if (dateTo) params.append('date_to', dateTo);
                
                url += params.toString();
                
                const response = await fetch(url);
                const result = await response.json();
                
                if (!response.ok) {
                    if (response.status === 401) {
                        window.location.href = '/login';
                        return;
                    }
                    document.getElementById('loading').innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Error loading filtered data: ${result.error}
                        </div>
                    `;
                    return;
                }
                
                allData = result.data;
                displayData(allData);
                
                document.getElementById('loading').style.display = 'none';
                document.getElementById('data-container').style.display = 'block';
                
            } catch (error) {
                console.error('Error applying filters:', error);
                document.getElementById('loading').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Error loading filtered data. Please try again.
                    </div>
                `;
            }
        }

        // Auto-refresh functionality
        let lastManualRefresh = 0;
        setInterval(() => {
            const now = Date.now();
            if (now - lastManualRefresh > 300000) {
                if (Object.keys(currentFilters).length > 0) {
                    applyFilters(currentFilters.state, currentFilters.plant, currentFilters.material, currentFilters.dateFrom, currentFilters.dateTo);
                } else {
                    loadLowFillRateData();
                }
            }
        }, 300000);

        function updateManualRefreshTime() {
            lastManualRefresh = Date.now();
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                updateManualRefreshTime();
                document.getElementById('apply-filters').click();
            }
            if (e.key === 'Escape') {
                updateManualRefreshTime();
                document.getElementById('clear-filters').click();
            }
        });

        // Add manual refresh tracking to buttons
        document.getElementById('apply-filters').addEventListener('click', updateManualRefreshTime);
        document.getElementById('clear-filters').addEventListener('click', updateManualRefreshTime);
        document.getElementById('today-filter').addEventListener('click', updateManualRefreshTime);
    </script>
</body>
</html>