<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gap Analysis Dashboard</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #1e3a8a;
            --secondary-color: #3b82f6;
            --accent-color: #dc2626;
            --success-color: #059669;
            --warning-color: #d97706;
            --dark-color: #1f2937;
            --light-bg: #f8fafc;
            --shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            --shadow-hover: 0 20px 40px rgba(0, 0, 0, 0.15);
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            min-height: 100vh;
        }

        .navbar {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--dark-color) 100%);
            box-shadow: var(--shadow);
            padding: 1rem 0;
        }

        .navbar-brand {
            font-size: 1.5rem;
            font-weight: 700;
            color: white !important;
        }

        .navbar-nav .nav-link {
            color: rgba(255, 255, 255, 0.8) !important;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .navbar-nav .nav-link:hover {
            color: white !important;
            transform: translateY(-2px);
        }

        .user-info {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 25px;
            padding: 0.5rem 1rem;
            margin-right: 1rem;
            backdrop-filter: blur(10px);
        }

        .logout-btn {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            border: none;
            border-radius: 25px;
            padding: 0.5rem 1rem;
            color: white;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(239, 68, 68, 0.3);
        }

        .filter-card, .data-table {
            background: white;
            border-radius: 20px;
            box-shadow: var(--shadow);
            border: 1px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }

        .filter-card:hover, .data-table:hover {
            box-shadow: var(--shadow-hover);
            transform: translateY(-2px);
        }

        .filter-header {
            background: linear-gradient(135deg, var(--secondary-color) 0%, var(--primary-color) 100%);
            color: white;
            border-radius: 20px 20px 0 0;
            padding: 1.5rem;
        }

        .filter-header h5 {
            margin: 0;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .form-control, .form-select {
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 0.75rem;
            transition: all 0.3s ease;
            font-size: 0.95rem;
        }

        .form-control:focus, .form-select:focus {
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            transform: translateY(-2px);
        }

        .btn {
            border-radius: 12px;
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            transition: all 0.3s ease;
            border: none;
            position: relative;
            overflow: hidden;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--secondary-color) 0%, var(--primary-color) 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(59, 130, 246, 0.3);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
            color: white;
        }

        .btn-info {
            background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success-color) 0%, #047857 100%);
            color: white;
        }

        .table-container {
            background: white;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: var(--shadow);
        }

        .table-header {
            background: linear-gradient(135deg, var(--dark-color) 0%, var(--primary-color) 100%);
            color: white;
            padding: 1.5rem;
        }

        .table-header h4 {
            margin: 0;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .record-badge {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 25px;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .table {
            margin: 0;
        }

        .table th {
            background: var(--light-bg);
            color: var(--dark-color);
            border: none;
            font-weight: 700;
            padding: 1rem 0.75rem;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .table td {
            padding: 1rem 0.75rem;
            border-bottom: 1px solid #f1f5f9;
            vertical-align: middle;
            font-size: 0.9rem;
        }

        .table tbody tr {
            transition: all 0.2s ease;
        }

        .table tbody tr:hover {
            background: var(--light-bg);
            transform: scale(1.01);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }

        .fill-rate-badge {
            font-size: 0.85rem;
            font-weight: 700;
            padding: 0.4rem 0.8rem;
            border-radius: 20px;
            text-align: center;
            min-width: 60px;
            display: inline-block;
        }

        .fill-rate-low {
            background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
            color: var(--accent-color);
            border: 2px solid #fecaca;
        }

        .inline-feedback {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .inline-feedback select {
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 0.4rem;
            font-size: 0.8rem;
            min-width: 180px;
        }

        .inline-feedback button {
            background: linear-gradient(135deg, var(--success-color) 0%, #047857 100%);
            border: none;
            border-radius: 8px;
            padding: 0.4rem 0.8rem;
            color: white;
            font-size: 0.8rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .inline-feedback button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(5, 150, 105, 0.3);
        }

        .inline-feedback button:disabled {
            background: #9ca3af;
            transform: none;
            box-shadow: none;
        }

        .loading {
            text-align: center;
            padding: 4rem;
            background: var(--light-bg);
            border-radius: 15px;
            margin: 2rem;
        }

        .spinner-border {
            color: var(--secondary-color);
            width: 3rem;
            height: 3rem;
        }

        .alert {
            border-radius: 15px;
            border: none;
            padding: 1.2rem;
            font-weight: 600;
        }

        .text-truncate-custom {
            max-width: 300px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .date-input-group {
            position: relative;
        }

        .date-input-group .form-control {
            padding-left: 2.5rem;
        }

        .date-input-group i {
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--secondary-color);
            z-index: 5;
        }

        .cascading-hint {
            font-size: 0.8rem;
            color: #6b7280;
            font-style: italic;
            margin-top: 4px;
        }

        .session-warning {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border-left: 4px solid var(--warning-color);
            color: #92400e;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            display: none;
        }

        @media (max-width: 768px) {
            .table-responsive {
                font-size: 0.8rem;
            }
            
            .btn {
                padding: 0.6rem 1rem;
                font-size: 0.85rem;
            }
            
            .filter-card .row > div {
                margin-bottom: 1rem;
            }

            .inline-feedback {
                flex-direction: column;
                gap: 0.3rem;
            }

            .inline-feedback select {
                min-width: 140px;
            }

            .navbar-nav {
                text-align: center;
            }

            .user-info {
                margin: 0.5rem 0;
            }
        }

        .animate-fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="fas fa-analytics"></i>
                Gap Analysis Dashboard
            </a>
            
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            
            <div class="collapse navbar-collapse" id="navbarNav">
                <div class="navbar-nav ms-auto d-flex align-items-center">
                    <div class="user-info">
                        <i class="fas fa-user me-2"></i>
                        <span id="user-email">Loading...</span>
                    </div>
                    <button class="logout-btn" id="logout-btn">
                        <i class="fas fa-sign-out-alt me-1"></i>
                        Logout
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Session Warning -->
        <div class="session-warning" id="session-warning">
            <i class="fas fa-clock me-2"></i>
            <strong>Session Expiring Soon:</strong> <span id="session-timer"></span>
        </div>

        <!-- Enhanced Filters Section -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="filter-card animate-fade-in">
                    <div class="filter-header">
                        <h5><i class="fas fa-sliders-h"></i>Smart Filters</h5>
                    </div>
                    <div class="p-4">
                        <div class="row g-3">
                            <!-- State Filter -->
                            <div class="col-lg-2 col-md-4">
                                <label for="state-filter" class="form-label">
                                    <i class="fas fa-map-marker-alt me-1"></i>State
                                </label>
                                <select class="form-select" id="state-filter">
                                    <option value="">All States</option>
                                </select>
                                <div class="cascading-hint">Filter plants by state</div>
                            </div>
                            
                            <!-- Plant Filter -->
                            <div class="col-lg-2 col-md-4">
                                <label for="plant-filter" class="form-label">
                                    <i class="fas fa-industry me-1"></i>Plant
                                </label>
                                <select class="form-select" id="plant-filter">
                                    <option value="">All Plants</option>
                                </select>
                                <div class="cascading-hint">Shows record counts</div>
                            </div>

                            <!-- Material Filter -->
                            <div class="col-lg-2 col-md-4">
                                <label for="material-filter" class="form-label">
                                    <i class="fas fa-box me-1"></i>Material
                                </label>
                                <select class="form-select" id="material-filter">
                                    <option value="">All Materials</option>
                                </select>
                                <div class="cascading-hint">Filter by product</div>
                            </div>
                            
                            <!-- Date From -->
                            <div class="col-lg-2 col-md-4">
                                <label for="date-from-filter" class="form-label">
                                    <i class="fas fa-calendar-alt me-1"></i>Date From
                                </label>
                                <div class="date-input-group">
                                    <i class="fas fa-calendar"></i>
                                    <input type="date" class="form-control" id="date-from-filter">
                                </div>
                            </div>
                            
                            <!-- Date To -->
                            <div class="col-lg-2 col-md-4">
                                <label for="date-to-filter" class="form-label">
                                    <i class="fas fa-calendar-check me-1"></i>Date To
                                </label>
                                <div class="date-input-group">
                                    <i class="fas fa-calendar"></i>
                                    <input type="date" class="form-control" id="date-to-filter">
                                </div>
                            </div>
                            
                            <!-- Action Buttons -->
                            <div class="col-lg-2 col-md-4 d-flex align-items-end gap-2">
                                <button class="btn btn-primary flex-fill" id="apply-filters">
                                    <i class="fas fa-search me-1"></i>Apply
                                </button>
                                <button class="btn btn-secondary" id="clear-filters">
                                    <i class="fas fa-eraser me-1"></i>Clear
                                </button>
                                <button class="btn btn-info" id="today-filter">
                                    <i class="fas fa-calendar-day me-1"></i>Today
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Enhanced Data Table -->
        <div class="table-container animate-fade-in">
            <div class="table-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h4><i class="fas fa-table"></i>Gap Analysis Records (Fill Rate < 95%)</h4>
                    <div class="record-badge" id="record-count">0 records</div>
                </div>
            </div>
            
            <div id="loading" class="loading">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <h5 class="mt-3 text-muted">Loading gap analysis data...</h5>
            </div>
            
            <div id="data-container" style="display: none;">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th>S.No</th>
                                <th>PO Number</th>
                                <th>Material Description</th>
                                <th>PO Date</th>
                                <th>Delivery Date</th>
                                <th>PO Qty (L)</th>
                                <th>Sales Qty</th>
                                <th>Fill Rate</th>
                                <th>Reason & Feedback</th>
                            </tr>
                        </thead>
                        <tbody id="data-table-body">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Success Modal -->
    <div class="modal fade" id="successModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-check-circle me-2"></i>
                        Feedback Saved
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    <i class="fas fa-check-circle text-success mb-3" style="font-size: 3rem;"></i>
                    <h5>Feedback Submitted Successfully!</h5>
                    <p class="text-muted">Thank you for providing feedback on this gap analysis record.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-success" data-bs-dismiss="modal">
                        <i class="fas fa-thumbs-up me-1"></i>Great!
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script>
        let allData = [];
        let plantsByState = {};
        let materials = [];
        let sessionTimer = null;

        // Reasons for non-fulfillment
        const REASONS = [
            "Product non Availability at Factory",
            "Product non Availability at SO",
            "Product non availability at CFA",
            "Supply not made as per PO time lines",
            "PO price issue",
            "Appointment issues",
            "Supply rejected by customer",
            "Mutiple point Delivery"
        ];

        // Load dashboard data on page load
        document.addEventListener('DOMContentLoaded', function() {
            verifySession();
            loadFilterOptions();
            loadLowFillRateData();
            startSessionTimer();
            
            // Logout button handler
            document.getElementById('logout-btn').addEventListener('click', logout);
        });

        // Verify session and load user info
        async function verifySession() {
            try {
                const response = await fetch('/api/verify-session');
                const result = await response.json();
                
                if (!response.ok || !result.valid) {
                    window.location.href = '/login';
                    return;
                }
                
                // Update user email in navbar
                document.getElementById('user-email').textContent = result.user_email;
                
                // Show session warning if less than 30 minutes remaining
                if (result.time_remaining_minutes < 30) {
                    showSessionWarning(result.time_remaining_minutes);
                }
                
            } catch (error) {
                console.error('Session verification error:', error);
                window.location.href = '/login';
            }
        }

        // Start session timer
        function startSessionTimer() {
            sessionTimer = setInterval(verifySession, 5 * 60 * 1000); // Check every 5 minutes
        }

        // Show session warning
        function showSessionWarning(minutesRemaining) {
            const sessionWarning = document.getElementById('session-warning');
            const sessionTimerSpan = document.getElementById('session-timer');
            
            sessionTimerSpan.textContent = `${minutesRemaining} minutes remaining`;
            sessionWarning.style.display = 'block';
        }

        // Logout function
        async function logout() {
            try {
                const response = await fetch('/api/logout', {
                    method: 'POST'
                });
                
                if (sessionTimer) {
                    clearInterval(sessionTimer);
                }
                
                window.location.href = '/login';
                
            } catch (error) {
                console.error('Logout error:', error);
                window.location.href = '/login';
            }
        }

        // Load filter options with cascading support
        async function loadFilterOptions() {
            try {
                const response = await fetch('/api/filter-options');
                const data = await response.json();
                
                if (data.error) {
                    console.error('Error loading filter options:', data.error);
                    return;
                }
                
                // Store data globally
                plantsByState = data.plants_by_state;
                materials = data.materials;
                
                // Populate state dropdown
                const stateSelect = document.getElementById('state-filter');
                stateSelect.innerHTML = '<option value="">All States</option>';
                data.states.forEach(state => {
                    const option = document.createElement('option');
                    option.value = state;
                    option.textContent = state;
                    stateSelect.appendChild(option);
                });

                // Populate material dropdown
                const materialSelect = document.getElementById('material-filter');
                materialSelect.innerHTML = '<option value="">All Materials</option>';
                data.materials.forEach(material => {
                    const option = document.createElement('option');
                    option.value = material;
                    option.textContent = material;
                    materialSelect.appendChild(option);
                });
                
                // Initially populate all plants
                populateAllPlants();
                
            } catch (error) {
                console.error('Error loading filter options:', error);
                if (error.message.includes('401')) {
                    window.location.href = '/login';
                }
            }
        }

        // Populate all plants (when no state is selected)
        function populateAllPlants() {
            const plantSelect = document.getElementById('plant-filter');
            plantSelect.innerHTML = '<option value="">All Plants</option>';
            
            // Add all plants with their counts
            Object.keys(plantsByState).forEach(state => {
                plantsByState[state].forEach(plant => {
                    const option = document.createElement('option');
                    option.value = plant.name;
                    option.textContent = `${plant.name} (${plant.count} records)`;
                    plantSelect.appendChild(option);
                });
            });
        }

        // Handle state selection change
        document.getElementById('state-filter').addEventListener('change', function() {
            const selectedState = this.value;
            const plantSelect = document.getElementById('plant-filter');
            
            // Clear current plant selection
            plantSelect.value = '';
            
            if (selectedState === '') {
                // Show all plants if no state selected
                populateAllPlants();
            } else {
                // Show only plants for selected state
                plantSelect.innerHTML = '<option value="">All Plants</option>';
                
                if (plantsByState[selectedState]) {
                    plantsByState[selectedState].forEach(plant => {
                        const option = document.createElement('option');
                        option.value = plant.name;
                        option.textContent = `${plant.name} (${plant.count} records)`;
                        plantSelect.appendChild(option);
                    });
                }
            }
        });

        // Load low fill rate data
        async function loadLowFillRateData() {
            try {
                const response = await fetch('/api/low-fill-rate-data');
                const result = await response.json();
                
                if (result.error) {
                    document.getElementById('loading').innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Error loading data: ${result.error}
                        </div>
                    `;
                    return;
                }
                
                allData = result.data;
                displayData(allData);
                
                document.getElementById('loading').style.display = 'none';
                document.getElementById('data-container').style.display = 'block';
                
            } catch (error) {
                console.error('Error loading data:', error);
                if (error.message.includes('401')) {
                    window.location.href = '/login';
                    return;
                }
                document.getElementById('loading').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Error loading data. Please try again.
                    </div>
                `;
            }
        }

        // Display data in table
        function displayData(data) {
            const tbody = document.getElementById('data-table-body');
            const recordCount = document.getElementById('record-count');
            
            tbody.innerHTML = '';
            recordCount.textContent = `${data.length} records`;
            
            if (data.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" class="text-center py-5">
                            <i class="fas fa-info-circle text-muted me-2"></i>
                            No gap analysis records found with fill rate < 95%
                        </td>
                    </tr>
                `;
                return;
            }
            
            data.forEach((record, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><span class="fw-bold text-primary">${index + 1}</span></td>
                    <td><span class="fw-bold">${record.po_no}</span></td>
                    <td>
                        <div class="text-truncate-custom" title="${record.material_description}">
                            ${record.material_description}
                        </div>
                    </td>
                    <td><small class="text-muted">${record.po_date || 'N/A'}</small></td>
                    <td><small class="text-muted">${record.delivery_date || 'N/A'}</small></td>
                    <td><span class="fw-semibold">${record.po_quantity.toLocaleString()}</span></td>
                    <td><span class="fw-semibold">${record.sales_quantity.toLocaleString()}</span></td>
                    <td>
                        <span class="fill-rate-badge fill-rate-low">
                            ${record.fill_rate_percent.toFixed(1)}%
                        </span>
                    </td>
                    <td>
                        <div class="inline-feedback">
                            <select class="reason-select" data-record-id="${record.id}">
                                <option value="">Select reason...</option>
                                ${REASONS.map(reason => `<option value="${reason}">${reason}</option>`).join('')}
                            </select>
                            <button class="save-btn" data-record-id="${record.id}" disabled>
                                <i class="fas fa-save"></i> Save
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });

            // Add event listeners for inline dropdowns
            addInlineFeedbackListeners();
        }

        // Add event listeners for inline feedback
        function addInlineFeedbackListeners() {
            // Enable save button when reason is selected
            document.querySelectorAll('.reason-select').forEach(select => {
                select.addEventListener('change', function() {
                    const saveBtn = document.querySelector(`.save-btn[data-record-id="${this.dataset.recordId}"]`);
                    saveBtn.disabled = !this.value;
                });
            });

            // Handle save button clicks
            document.querySelectorAll('.save-btn').forEach(button => {
                button.addEventListener('click', async function() {
                    const recordId = this.dataset.recordId;
                    const reasonSelect = document.querySelector(`.reason-select[data-record-id="${recordId}"]`);
                    const reason = reasonSelect.value;

                    if (!reason) return;

                    try {
                        this.disabled = true;
                        this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';

                        const response = await fetch('/api/submit-feedback', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                record_id: parseInt(recordId),
                                reason: reason,
                                comments: ''
                            })
                        });

                        const result = await response.json();

                        if (!response.ok) {
                            if (response.status === 401) {
                                window.location.href = '/login';
                                return;
                            }
                            throw new Error(result.error);
                        }

                        // Show success
                        this.innerHTML = '<i class="fas fa-check"></i> Saved';
                        this.style.background = '#10b981';
                        reasonSelect.disabled = true;

                        // Show success modal
                        new bootstrap.Modal(document.getElementById('successModal')).show();

                    } catch (error) {
                        console.error('Error saving feedback:', error);
                        this.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Error';
                        this.style.background = '#ef4444';
                        this.disabled = false;
                        
                        setTimeout(() => {
                            this.innerHTML = '<i class="fas fa-save"></i> Save';
                            this.style.background = '';
                        }, 3000);
                    }
                });
            });
        }

        // Enhanced filter functionality
        document.getElementById('apply-filters').addEventListener('click', function() {
            const stateFilter = document.getElementById('state-filter').value;
            const plantFilter = document.getElementById('plant-filter').value;
            const materialFilter = document.getElementById('material-filter').value;
            const dateFromFilter = document.getElementById('date-from-filter').value;
            const dateToFilter = document.getElementById('date-to-filter').value;
            
            applyFilters(stateFilter, plantFilter, materialFilter, dateFromFilter, dateToFilter);
        });
        
        document.getElementById('clear-filters').addEventListener('click', function() {
            document.getElementById('state-filter').value = '';
            document.getElementById('plant-filter').value = '';
            document.getElementById('material-filter').value = '';
            document.getElementById('date-from-filter').value = '';
            document.getElementById('date-to-filter').value = '';
            
            // Reset plants to show all
            populateAllPlants();
            
            loadLowFillRateData();
        });

        document.getElementById('today-filter').addEventListener('click', function() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('date-from-filter').value = today;
            document.getElementById('date-to-filter').value = today;
            
            const stateFilter = document.getElementById('state-filter').value;
            const plantFilter = document.getElementById('plant-filter').value;
            const materialFilter = document.getElementById('material-filter').value;
            
            applyFilters(stateFilter, plantFilter, materialFilter, today, today);
        });

        // Apply filters function
        async function applyFilters(state, plant, material, dateFrom, dateTo) {
            try {
                document.getElementById('loading').style.display = 'block';
                document.getElementById('data-container').style.display = 'none';
                
                let url = '/api/filtered-data?';
                const params = new URLSearchParams();
                
                if (state) params.append('state', state);
                if (plant) params.append('plant', plant);
                if (material) params.append('material', material);
                if (dateFrom) params.append('date_from', dateFrom);
                if (dateTo) params.append('date_to', dateTo);
                
                url += params.toString();
                
                const response = await fetch(url);
                const result = await response.json();
                
                if (!response.ok) {
                    if (response.status === 401) {
                        window.location.href = '/login';
                        return;
                    }
                    document.getElementById('loading').innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Error loading filtered data: ${result.error}
                        </div>
                    `;
                    return;
                }
                
                allData = result.data;
                displayData(allData);
                
                document.getElementById('loading').style.display = 'none';
                document.getElementById('data-container').style.display = 'block';
                
            } catch (error) {
                console.error('Error applying filters:', error);
                document.getElementById('loading').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Error loading filtered data. Please try again.
                    </div>
                `;
            }
        }

        // Auto-refresh data every 5 minutes
        setInterval(() => {
            loadLowFillRateData();
        }, 300000);

        // Add keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                document.getElementById('apply-filters').click();
            }
            if (e.key === 'Escape') {
                document.getElementById('clear-filters').click();
            }
        });
    </script>
</body>
</html>